<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Macro Execution Dashboard</title>

<style>
:root {
  --bg:#0e1117;
  --card:#161b22;
  --text:#e6edf3;
  --muted:#9da7b3;
  --bull:#2ecc71;
  --bear:#e74c3c;
  --neutral:#f1c40f;
  --warn:#ff9f43;
}

* { box-sizing: border-box; }

body {
  margin:0;
  font-family: Inter, system-ui, sans-serif;
  background:var(--bg);
  color:var(--text);
}

.container {
  max-width:1200px;
  margin:auto;
  padding:24px;
}

h1 { margin-bottom:6px; }

.updated {
  font-size:13px;
  color:var(--muted);
  margin-bottom:16px;
}

.banner {
  background:#1f2937;
  border-left:6px solid var(--warn);
  padding:14px 16px;
  border-radius:10px;
  margin-bottom:24px;
  font-size:14px;
}

.grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
  gap:20px;
}

.card {
  background:var(--card);
  border-radius:14px;
  padding:20px;
}

.asset { font-size:20px; margin-bottom:6px; }

.bias { font-size:34px; font-weight:700; }

.bullish {color:var(--bull);}
.bearish {color:var(--bear);}
.neutral {color:var(--neutral);}

.conf {
  font-size:13px;
  color:var(--muted);
  margin-bottom:10px;
}

.permission {
  font-size:22px;
  font-weight:700;
}

.green {color:var(--bull);}
.amber {color:var(--warn);}
.red {color:var(--bear);}

select {
  width:100%;
  padding:8px;
  background:#0e1117;
  color:var(--text);
  border:1px solid #2a2f36;
  border-radius:6px;
  margin-top:6px;
}

.badge {
  display:inline-block;
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:600;
}

.badge.on {background:rgba(46,204,113,0.15); color:var(--bull);}
.badge.off {background:rgba(231,76,60,0.15); color:var(--bear);}
.badge.mixed {background:rgba(241,196,15,0.15); color:var(--neutral);}

.regime-explain {
  margin-top:12px;
  font-size:14px;
  line-height:1.5;
}
</style>
</head>

<body>
<div class="container">

<h1>Macro Execution Dashboard</h1>
<div class="updated" id="updated">Loading…</div>

<div class="banner" id="riskBanner">Checking macro risk…</div>

<div class="grid">
  <div class="card" id="us500"></div>
  <div class="card" id="gold"></div>
</div>

<h3>15-Minute EMA Bias (Manual)</h3>
<div class="grid">
  <div class="card" id="us500Permission"></div>
  <div class="card" id="goldPermission"></div>
</div>

<h3>Market Regime</h3>
<div class="card" id="regime"></div>

</div>

<script>
fetch("latest.json")
.then(r => r.json())
.then(data => {

  document.getElementById("updated").innerText =
    "Last updated (UTC): " + data.updated_utc.replace("T"," ").split(".")[0];

  // Macro risk banner
  if (data.macro_risk && data.macro_risk.risk) {
    riskBanner.innerHTML = "⚠️ " + data.macro_risk.message;
    riskBanner.style.borderLeftColor = "#e74c3c";
  } else {
    riskBanner.innerHTML = "✅ No high-impact macro risk (CPI / FOMC / NFP)";
    riskBanner.style.borderLeftColor = "#2ecc71";
  }

  renderAsset("us500","US500",data.us500);
  renderAsset("gold","Gold (XAUUSD)",data.gold);

  // Load saved EMA bias or default to Neutral
  const emaBias = {
    us500: localStorage.getItem("ema_us500") || "Neutral",
    gold: localStorage.getItem("ema_gold") || "Neutral"
  };

  renderPermission("us500Permission","US500",data.us500,"ema_us500",emaBias.us500);
  renderPermission("goldPermission","Gold",data.gold,"ema_gold",emaBias.gold);

  // Market regime
  const regime = data.risk_regime || "Mixed";
  const cls = regime === "Risk-On" ? "on" : regime === "Risk-Off" ? "off" : "mixed";

  document.getElementById("regime").innerHTML = `
    <div class="badge ${cls}">${regime}</div>
    <div class="regime-explain">
      <strong>Risk-On:</strong> Trend continuation favoured. Buy pullbacks, allow runners.<br>
      <strong>Risk-Off:</strong> Defensive conditions. Expect chop, failed breaks.<br>
      <strong>Mixed:</strong> No dominant macro tailwind. A+ setups only.
    </div>
  `;
});

function renderAsset(id,title,obj){
  const cls=obj.bias.toLowerCase();
  document.getElementById(id).innerHTML = `
    <div class="asset">${title}</div>
    <div class="bias ${cls}">${obj.bias}</div>
    <div class="conf">Confidence: ${obj.confidence}</div>
    <ul>${obj.drivers.map(d=>`<li>${d}</li>`).join("")}</ul>
  `;
}

function renderPermission(id,title,fund,storageKey,currentBias){
  let text="Stand Aside", cls="red";
  if (currentBias===fund.bias && fund.confidence==="High"){ text="Full Size Allowed"; cls="green";}
  else if (currentBias===fund.bias){ text="Reduce Size / A+ Only"; cls="amber";}

  document.getElementById(id).innerHTML = `
    <div class="asset">${title}</div>
    <label class="conf">15m EMA Bias</label>
    <select onchange="updateBias('${storageKey}', this.value)">
      <option ${currentBias==="Bullish"?"selected":""}>Bullish</option>
      <option ${currentBias==="Bearish"?"selected":""}>Bearish</option>
      <option ${currentBias==="Neutral"?"selected":""}>Neutral</option>
    </select>
    <div class="permission ${cls}" style="margin-top:10px">${text}</div>
  `;
}

function updateBias(key,value){
  localStorage.setItem(key,value);
  location.reload();
}
</script>
</body>
</html>
